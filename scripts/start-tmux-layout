#!/usr/bin/env bash
set -euo pipefail

# Default session name to the basename of the current workdir if not provided
if [ -z "${TMUX_SESSION:-}" ]; then
  TMUX_SESSION="$(basename "${PWD}" 2>/dev/null || echo workspace)"
fi

export TERM="${TERM:-xterm-256color}"
export LANG="${LANG:-C.UTF-8}"
export TMUX_TMPDIR="${TMUX_TMPDIR:-/tmp}"

# Ensure tmux server is up
tmux start-server || true

# Allow longer session name in tmux status bar (status-left)
STATUS_LEFT_LENGTH="${TMUX_STATUS_LEFT_LENGTH:-32}"
# Apply globally for new sessions
(tmux set-option -g -q status-left-length "${STATUS_LEFT_LENGTH}" || true)

# Keybinding: Ctrl-b then Q to kill ALL tmux sessions (with confirmation)
# Bind explicitly in the root key table to avoid table/override issues, and unbind any previous mapping.
tmux unbind-key -T root Q 2>/dev/null || true
tmux bind-key -T root Q confirm-before -p "Kill ALL tmux sessions and exit container? (y/n)" kill-server || true

# Create the session if it does not exist
if ! tmux has-session -t "${TMUX_SESSION}" 2>/dev/null; then
  # First tab: codex (kept alive with exec bash -l)
  tmux new-session -d -s "${TMUX_SESSION}" -n codex \
    "/bin/bash" -lc "codex || true; exec bash -l" || {
      echo "[start-tmux-layout] Failed to create tmux session: ${TMUX_SESSION}" >&2
      exec /bin/bash -l
    }
  # Second tab: shell
  tmux new-window  -t "${TMUX_SESSION}:" -n shell "/bin/bash -l" || true
  # Third tab: shell
  tmux new-window  -t "${TMUX_SESSION}:" -n shell "/bin/bash -l" || true
  # Fourth tab: htop
  tmux new-window  -t "${TMUX_SESSION}:" -n htop  "htop" || true
  # Make Codex window active by default (select by name to avoid index issues)
  tmux select-window -t "${TMUX_SESSION}:codex" || true
fi

# Re-assert the kill-all binding after any session creation, in case earlier bind failed
# (Binding is global; this is idempotent.)
tmux unbind-key -T root Q 2>/dev/null || true
tmux bind-key -T root Q confirm-before -p "Kill ALL tmux sessions? (y/n)" kill-server || true

# Ensure longer status-left length for this specific session (helps if session already existed)
(tmux set-option -t "${TMUX_SESSION}" -q status-left-length "${STATUS_LEFT_LENGTH}" || true)

# Ensure Codex window is selected on attach
tmux select-window -t "${TMUX_SESSION}:codex" || true
# Try to attach; on failure, show diagnostics and fall back to a shell
if ! exec tmux attach -t "${TMUX_SESSION}"; then
  echo "[start-tmux-layout] tmux attach failed. Diagnostics:" >&2
  tmux list-sessions 2>&1 || true
  ps -ef | grep tmux | grep -v grep || true
  echo "TERM=$TERM LANG=$LANG TMUX=${TMUX-} TMUX_TMPDIR=${TMUX_TMPDIR-}" >&2
  exec /bin/bash -l
fi
